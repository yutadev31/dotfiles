#!/bin/sh
set -ue

install_file() {
  path=$1
  dotdir=$(pwd)

  if [ -L "$HOME/$path" ]; then return; fi

  if [ -e "$HOME/$path" ]; then
    mv $HOME/$path $HOME/$path.old
    echo "Move ~/$path"
  fi

  mkdir -p $(dirname $HOME/$path)
  ln -sf $dotdir/home/$path $HOME/$path
}

install_files() {
  echo "Installing files..."

  install_file .bin
  install_file .config/fastfetch
  install_file .config/fish
  install_file .config/nvim
  install_file .config/tmux
  install_file .gitmessage
  install_file .zshrc

  if [ $1 = "desktop" ]; then
    install_file .config/alacritty
    install_file .config/gtk-2.0
    install_file .config/gtk-3.0
    install_file .config/hypr
    install_file .config/mako
    install_file .config/rofi
    install_file .config/waybar
    install_file wallpaper.png
  fi
}

install_tpm() {
  if [ ! -d ~/.tmux/plugins/tpm ]; then
    echo "Installing tpm..."
    git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
  fi
}

install_packages() {
  echo "Installing packages..."

  sudo pacman -S --noconfirm --needed $(cat packages/cli.txt)

  if [ $1 = "desktop" ]; then
    sudo pacman -S --noconfirm --needed $(cat packages/desktop.txt)
  fi
}

install() {
  echo "Installing dotfiles..."

  echo $1 >config.txt

  install_packages $1
  install_files $1
  install_tpm

  echo "Installed dotfiles successfully."
}

show_help() {
  echo "Usage: ./install [OPTIONS]"
  echo ""
  echo "Options:"
  echo "  -c    Install CLI tools only"
  echo "  -d    Install desktop environment (includes CLI tools)"
  echo "  -h    Show this help message and exit"
  echo ""
  echo "Notes:"
  echo "  - Once you choose an option, it will be remembered."
  echo "  - The next time you run this script, the previously chosen option"
  echo "    will be used as the default."
  exit 0
}

while getopts "cdh" opt; do
  case "$opt" in
  c)
    install cli
    exit 0
    ;;
  d)
    install desktop
    exit 0
    ;;
  h) show_help ;;
  ?) exit 1 ;;
  esac
done

if [ -e "config.txt" ]; then
  install $(cat config.txt)
else
  show_help
  exit 1
fi
